---
output: github_document
---

This notebook generates plots from the `.csv` results produced by the corresponding python scripts.  We compare policies across constant effort (MSY-like policies), constant escapement, and the RL agent (PPO).


```{r setup}
library(tidyverse)

best_reward <- function(df) {
  df |> 
  group_by(action, rep) |>
  filter(t == max(t)) |> 
  group_by(action) |>
  summarise(mean_reward = mean(reward), sd = sd(reward)) |> 
  filter(mean_reward == max(mean_reward))
}
```


# Constant Effort

```{r}
msy <- read_csv("../data/msy.csv.gz")
best <- best_reward(msy)
best
```

```{r}
rewards <- msy |>
  group_by(action, rep) |>
  filter(t == max(t)) |> 
  group_by(action) |>
  summarise(mean_reward = mean(reward),
            sd = sd(reward)) 

rewards |>
  filter(action < 0.1) |>
  ggplot(aes(action, mean_reward, 
             ymin = mean_reward - 2*sd,
             ymax=mean_reward+2*sd)) +
  geom_point() + geom_ribbon(alpha=0.4)
```


```{r}
msy_sim <- msy |>
  filter(action == best$action) |> 
  pivot_longer(c("sp1", "sp2", "sp3"),
               names_to = "species", values_to = "abundance") |>
  mutate(abundance = abundance + 1) # natural units

msy_sim |>
  filter(rep < 4) |>
  ggplot(aes(t, abundance,  col=species)) + 
    geom_line() + facet_wrap(~rep)

msy_sim |> 
  filter(rep < 30, species == "sp1") |>
  ggplot(aes(t, abundance, group = interaction(rep,species),  col=species)) + 
    geom_line(alpha=0.5) 


```
```{r}
msy_sim |> 
  group_by(rep) |>
  filter(t==max(t), species=="sp1") |>
  ggplot(aes(rep, reward)) + geom_col()
```
# TAC

80% of  MSY

```{r}
actions <- unique(msy$action)
i <- which.min(abs(actions - best$action* 0.8))
tac_sim <- msy |> 
  filter(action == actions[[i]]) |>
  pivot_longer(c("sp1", "sp2", "sp3"),
               names_to = "species", values_to = "abundance")
tac_sim |>
  filter(rep < 4) |>
  ggplot(aes(t, abundance,  col=species)) + 
    geom_line() + facet_wrap(~rep)

```
```{r}
tac_sim |> 
  group_by(rep) |>
  filter(t==max(t), species=="sp1") |>
  ggplot(aes(rep, reward)) + geom_col()
```

# PPO Agent


```{r}
ppo <- read_csv("../data/PPO250.csv.gz")

```

```{r}
overall_ppo <- 
ppo |> 
  group_by(rep) |>
  filter(t==max(t)) |> ungroup() |>
  filter(reward > 0) |>
  summarise(reward = mean(reward),
            t = mean(t),
            effort = mean(action)) |>
  mutate(policy="ppo")
overall_ppo

ppo |> 
  group_by(rep) |>
  filter(t==max(t)) |> 
  ggplot(aes(rep, reward)) + geom_col()
```

```{r}
ppo_sims <- ppo |> 
  mutate(escapement = (sp1+1) - action * (sp1+1),
         effort = action) |>
  pivot_longer(c("sp1", "sp2", "sp3"),
               names_to = "species", values_to = "abundance") |>
  mutate(abundance = abundance + 1)

ppo_sims |>
  filter(rep < 4) |>
  ggplot(aes(t, abundance, col=species)) +
  geom_line(alpha=0.6) + facet_wrap(~rep)
```


```{r}
ppo_sims |>
  filter(species == "sp1") |>
  group_by(t) |>
  summarise(abundance = mean(abundance), 
            effort = mean(effort),
            escapement = mean(escapement)) |> 
  pivot_longer(-t, names_to = "metric", values_to = "population") |>
  ggplot(aes(t, population, col=metric)) + geom_line()
```






# Constant Escapement

```{r}
escapement <- read_csv("../data/escapement.csv.gz", show_col_types = FALSE)

## Determine which level of constant escapement gives highest net reward
best_e <- best_reward(escapement)
best_e
```

```{r}
esc_sims <- escapement |> 
  filter(action == best_e$action) |>
  pivot_longer(c("sp1", "sp2", "sp3"),
               names_to = "species", values_to = "abundance") |>
  mutate(abundance = abundance + 1) |>
  rename(escapement = action)

esc_sims |>
  filter(rep < 4) |>
  ggplot(aes(t, abundance, col=species)) + geom_line() +
  geom_line(aes(t, escapement), col="grey50") +
  facet_wrap(~rep)
```


```{r}
rewards <- escapement |>
  group_by(action, rep) |>
  filter(t == max(t)) |> 
  group_by(action) |>
  summarise(mean_reward = mean(reward),
            sd = sd(reward)) 

rewards |>
  ggplot(aes(action, mean_reward, 
             ymin = mean_reward - 2*sd,
             ymax=mean_reward+2*sd)) +
  geom_point() + geom_ribbon(alpha=0.4)
```

